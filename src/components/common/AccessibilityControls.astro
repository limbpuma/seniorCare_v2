---
/**
 * AccessibilityControls - Componente optimizado para Astro + Tailwind CSS
 * Prioriza utilidades Tailwind y minimiza JavaScript/CSS custom
 */
interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<!-- Importar estilos específicos optimizados -->
<style>
  @import '../../styles/accessibility-optimized.css';
</style>

<!-- Widget de Accesibilidad - Optimizado para Astro + Tailwind -->
<div 
  class={`accessibility-widget fixed bottom-5 right-5 z-50 font-sans ${className || ''}`} 
  role="region" 
  aria-label="Barrierefreiheitsoptionen"
>
  <!-- Panel de controles - Diseño completamente con Tailwind -->
  <div 
    class="accessibility-panel absolute bottom-20 right-0 bg-white rounded-2xl shadow-2xl border border-gray-200 min-w-80 max-w-96 transform transition-all duration-300 ease-in-out opacity-0 invisible translate-y-4 scale-95" 
    id="accessibilityPanel"
    role="dialog" 
    aria-labelledby="accessibility-title" 
    aria-modal="false"
  >
    <!-- Encabezado -->
    <div class="flex justify-between items-center p-5 border-b border-gray-200 bg-gradient-to-r from-slate-50 to-gray-50 rounded-t-2xl">
      <h3 id="accessibility-title" class="text-lg font-semibold text-gray-800 m-0">
        Barrierefreiheit
      </h3>
      <button 
        id="closeAccessibilityPanel" 
        class="bg-transparent border-none text-gray-600 p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
        aria-label="Panel schließen"
        title="Barrierefreiheitspanel schließen"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Estado -->
    <div class="px-5 py-3 bg-blue-50 border-b border-gray-100">
      <div class="flex items-center gap-2 text-sm text-blue-700">
        <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
        <span id="accessibility-status">0 Funktionen aktiv</span>
      </div>
    </div>
    
    <!-- Controles - Optimizados con Tailwind -->
    <div class="p-5 space-y-3">
      <!-- Text Spacing Control -->
      <button 
        id="toggleTextSpacing" 
        class="accessibility-feature-btn w-full p-4 border-2 border-gray-200 rounded-xl bg-white flex items-center gap-4 text-left hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
        aria-label="Textabstand anpassen für bessere Lesbarkeit"
        aria-pressed="false"
        aria-keyshortcuts="Alt+T"
        data-feature="textSpacing"
      >
        <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">🔤</span>
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-medium text-gray-900">Text Spacing</div>
          <div class="text-sm text-gray-600">Verbessert die Lesbarkeit</div>
        </div>
        <div class="flex-shrink-0">
          <span class="feature-status px-3 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">AUS</span>
        </div>
      </button>
      
      <!-- High Contrast Control -->
      <button 
        id="highContrastMode" 
        class="accessibility-feature-btn w-full p-4 border-2 border-gray-200 rounded-xl bg-white flex items-center gap-4 text-left hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
        aria-label="Hohen Kontrast aktivieren für bessere Sichtbarkeit"
        aria-pressed="false"
        aria-keyshortcuts="Alt+C"
        data-feature="highContrast"
      >
        <div class="flex-shrink-0 w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">🎨</span>
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-medium text-gray-900">Hoher Kontrast</div>
          <div class="text-sm text-gray-600">Verbessert die Sichtbarkeit</div>
        </div>
        <div class="flex-shrink-0">
          <span class="feature-status px-3 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">AUS</span>
        </div>
      </button>
      
      <!-- Focus Indicators Control -->
      <button 
        id="focusIndicators" 
        class="accessibility-feature-btn w-full p-4 border-2 border-gray-200 rounded-xl bg-white flex items-center gap-4 text-left hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
        aria-label="Fokusindikatoren verstärken für bessere Navigation"
        aria-pressed="false"
        aria-keyshortcuts="Alt+F"
        data-feature="focusIndicators"
      >
        <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">🎯</span>
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-medium text-gray-900">Fokus verbessern</div>
          <div class="text-sm text-gray-600">Klarere Navigation</div>
        </div>
        <div class="flex-shrink-0">
          <span class="feature-status px-3 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">AUS</span>
        </div>
      </button>
    </div>
    
    <!-- Botones de acción -->
    <div class="px-5 pb-5 pt-2 border-t border-gray-100">
      <div class="flex gap-3">
        <button 
          id="resetAccessibility" 
          class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors duration-200"
          aria-label="Alle Einstellungen zurücksetzen"
          title="Alle Barrierefreiheitseinstellungen zurücksetzen"
        >
          🔄 Zurücksetzen
        </button>
        
        <a 
          href="/accessibility" 
          class="flex-1 px-4 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-lg text-center hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
          aria-label="Zur Barrierefreiheitsseite"
          aria-keyshortcuts="Alt+A"
          title="Vollständige Informationen zur Barrierefreiheit (Alt+A)"
        >
          ℹ️ Mehr Infos
        </a>
      </div>
    </div>
  </div>

  <!-- Botón flotante - Completamente optimizado para Tailwind -->
   <button 
    id="toggleAccessibilityPanel" 
    class="accessibility-toggle-btn w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full shadow-xl border-2 border-white text-white flex items-center justify-center hover:scale-105 hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-blue-300/50 transition-all duration-300 ease-out"
    aria-label="Barrierefreiheitsoptionen öffnen"
    aria-expanded="false"
    aria-controls="accessibilityPanel"
    title="Barrierefreiheitsoptionen öffnen/schließen"  >    <svg class="w-8 h-8 drop-shadow-sm" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <circle cx="12" cy="12" r="11" stroke="currentColor" stroke-width="1.5" fill="none"/>
      <path fill="currentColor" d="M12 6.5c0.83 0 1.5-0.67 1.5-1.5s-0.67-1.5-1.5-1.5-1.5 0.67-1.5 1.5 0.67 1.5 1.5 1.5zm-1.77 1.23c-0.8 0.35-1.38 1.09-1.52 2.02L8.29 12H5c-0.55 0-1 0.45-1 1s0.45 1 1 1h3.69l-0.51 3.03c-0.09 0.55 0.28 1.07 0.83 1.16 0.06 0.01 0.11 0.01 0.17 0.01 0.48 0 0.9-0.35 0.98-0.84L10.72 14h2.56l0.56 2.36c0.11 0.48 0.54 0.82 1.02 0.82 0.08 0 0.16-0.01 0.24-0.03 0.56-0.13 0.9-0.69 0.77-1.25L15.31 13H19c0.55 0 1-0.45 1-1s-0.45-1-1-1h-4.09l-0.49-2.39c-0.2-1-1.09-1.76-2.16-1.76h-0.53c-0.55 0-1 0.45-1 1s0.45 1 1 1h0.53l0.28 1.37L12.9 10H11.1l-0.39-1.96c0.1-0.05 0.21-0.08 0.32-0.08h0.53c0.04 0 0.08-0.01 0.11-0.01z"/>
    </svg>
  </button>
</div>

<script>
  /**
   * AccessibilityManager - Reestructurado para Astro + Tailwind
   * JavaScript mínimo, máximo aprovechamiento de utilidades CSS
   */
  class AccessibilityManager {
    public features: {
      textSpacing: boolean;
      highContrast: boolean;
      focusIndicators: boolean;
    };
    public panel: HTMLElement | null;
    public toggleButton: HTMLElement | null;
    public statusElement: HTMLElement | null;
    public isVisible: boolean;

    constructor() {
      this.features = {
        textSpacing: false,
        highContrast: false,
        focusIndicators: false
      };
      this.panel = null;
      this.toggleButton = null;
      this.statusElement = null;
      this.isVisible = false;
      this.init();
    }

    init(): void {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.setupElements());
      } else {
        this.setupElements();
      }
    }

    setupElements(): void {
      this.panel = document.getElementById('accessibilityPanel');
      this.toggleButton = document.getElementById('toggleAccessibilityPanel');
      this.statusElement = document.getElementById('accessibility-status');
      
      if (!this.panel || !this.toggleButton) return;
      
      this.bindEvents();
      this.loadSavedPreferences();
      this.updateStatus();
    }

    bindEvents(): void {
      // Toggle panel
      this.toggleButton?.addEventListener('click', () => this.togglePanel());
      
      // Close panel
      document.getElementById('closeAccessibilityPanel')?.addEventListener('click', () => this.hidePanel());
      
      // Feature toggles
      document.getElementById('toggleTextSpacing')?.addEventListener('click', () => 
        this.toggleFeature('textSpacing'));
      document.getElementById('highContrastMode')?.addEventListener('click', () => 
        this.toggleFeature('highContrast'));
      document.getElementById('focusIndicators')?.addEventListener('click', () => 
        this.toggleFeature('focusIndicators'));
      
      // Reset button
      document.getElementById('resetAccessibility')?.addEventListener('click', () => 
        this.resetAllPreferences());
      
      // Event handlers
      document.addEventListener('keydown', (e: KeyboardEvent) => this.handleKeyboardShortcuts(e));
      document.addEventListener('click', (e: MouseEvent) => this.handleOutsideClick(e));
      document.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'Escape' && this.isPanelVisible()) {
          this.hidePanel();
        }
      });
    }

    togglePanel(): void {
      this.isPanelVisible() ? this.hidePanel() : this.showPanel();
    }

    showPanel(): void {
      if (!this.panel) return;
      
      // Usar solo clases Tailwind para transiciones
      this.panel.classList.remove('opacity-0', 'invisible', 'translate-y-4', 'scale-95');
      this.panel.classList.add('opacity-100', 'visible', 'translate-y-0', 'scale-100');
      
      this.toggleButton?.setAttribute('aria-expanded', 'true');
      this.toggleButton?.setAttribute('aria-label', 'Barrierefreiheitsoptionen schließen');
      this.isVisible = true;
    }

    hidePanel(): void {
      if (!this.panel) return;
      
      // Usar solo clases Tailwind para transiciones
      this.panel.classList.add('opacity-0', 'invisible', 'translate-y-4', 'scale-95');
      this.panel.classList.remove('opacity-100', 'visible', 'translate-y-0', 'scale-100');
      
      this.toggleButton?.setAttribute('aria-expanded', 'false');
      this.toggleButton?.setAttribute('aria-label', 'Barrierefreiheitsoptionen öffnen');
      this.isVisible = false;
    }

    isPanelVisible(): boolean {
      return this.panel?.classList.contains('opacity-100') || false;
    }

    toggleFeature(feature: keyof AccessibilityManager['features']): void {
      this.features[feature] = !this.features[feature];
      this.applyFeature(feature);
      this.updateFeatureButton(feature);
      this.savePreferences();
      this.updateStatus();
    }

    applyFeature(feature: keyof AccessibilityManager['features']): void {
      const isEnabled = this.features[feature];
      
      switch (feature) {
        case 'textSpacing':
          this.applyTextSpacing(isEnabled);
          break;
        case 'highContrast':
          this.applyHighContrast(isEnabled);
          break;
        case 'focusIndicators':
          this.applyFocusIndicators(isEnabled);
          break;
      }
    }

    // Métodos de aplicación de características - Mínimo JavaScript
    applyTextSpacing(enabled: boolean): void {
      if (enabled) {
        document.documentElement.style.setProperty('--text-spacing-multiplier', '1.5');
        document.body.style.lineHeight = '1.8';
        document.body.style.letterSpacing = '0.05em';
        document.body.style.wordSpacing = '0.1em';
      } else {
        document.documentElement.style.removeProperty('--text-spacing-multiplier');
        document.body.style.lineHeight = '';
        document.body.style.letterSpacing = '';
        document.body.style.wordSpacing = '';
      }
    }

    applyHighContrast(enabled: boolean): void {
      if (enabled) {
        document.documentElement.classList.add('high-contrast-mode');
        document.documentElement.style.filter = 'contrast(150%) brightness(1.1)';
      } else {
        document.documentElement.classList.remove('high-contrast-mode');
        document.documentElement.style.filter = '';
      }
    }

    applyFocusIndicators(enabled: boolean): void {
      const styleId = 'enhanced-focus-styles';
      
      if (enabled) {
        if (!document.getElementById(styleId)) {
          const style = document.createElement('style');
          style.id = styleId;
          style.textContent = `
            *:focus {
              outline: 3px solid #ff6600 !important;
              outline-offset: 2px !important;
              box-shadow: 0 0 0 5px rgba(255, 102, 0, 0.3) !important;
            }
          `;
          document.head.appendChild(style);
        }
        document.documentElement.classList.add('enhanced-focus-mode');
      } else {
        document.getElementById(styleId)?.remove();
        document.documentElement.classList.remove('enhanced-focus-mode');
      }
    }

    updateFeatureButton(feature: keyof AccessibilityManager['features']): void {
      const button = document.querySelector(`[data-feature="${feature}"]`) as HTMLElement;
      const status = button?.querySelector('.feature-status') as HTMLElement;
      const isEnabled = this.features[feature];
      
      if (button && status) {
        button.setAttribute('aria-pressed', isEnabled.toString());
        status.textContent = isEnabled ? 'EIN' : 'AUS';
        
        // Usar solo clases Tailwind para estados
        if (isEnabled) {
          button.classList.add('bg-blue-50', 'border-blue-500');
          button.classList.remove('border-gray-200');
          status.classList.add('bg-blue-200', 'text-blue-800');
          status.classList.remove('bg-gray-100', 'text-gray-600');
        } else {
          button.classList.remove('bg-blue-50', 'border-blue-500');
          button.classList.add('border-gray-200');
          status.classList.remove('bg-blue-200', 'text-blue-800');
          status.classList.add('bg-gray-100', 'text-gray-600');
        }
      }
    }

    updateStatus(): void {
      const activeCount = Object.values(this.features).filter(Boolean).length;
      if (this.statusElement) {
        this.statusElement.textContent = `${activeCount} ${activeCount === 1 ? 'Funktion aktiv' : 'Funktionen aktiv'}`;
      }
    }

    resetAllPreferences(): void {
      Object.keys(this.features).forEach(feature => {
        this.features[feature as keyof AccessibilityManager['features']] = false;
        this.applyFeature(feature as keyof AccessibilityManager['features']);
        this.updateFeatureButton(feature as keyof AccessibilityManager['features']);
      });
      this.savePreferences();
      this.updateStatus();
    }

    savePreferences(): void {
      try {
        localStorage.setItem('accessibility-preferences', JSON.stringify(this.features));
      } catch (e) {
        console.warn('Could not save accessibility preferences:', e);
      }
    }

    loadSavedPreferences(): void {
      try {
        const saved = localStorage.getItem('accessibility-preferences');
        if (saved) {
          const preferences = JSON.parse(saved);
          Object.keys(this.features).forEach(feature => {
            const featureKey = feature as keyof AccessibilityManager['features'];
            if (preferences[featureKey]) {
              this.features[featureKey] = true;
              this.applyFeature(featureKey);
              this.updateFeatureButton(featureKey);
            }
          });
        }
      } catch (e) {
        console.warn('Could not load accessibility preferences:', e);
      }
    }

    handleKeyboardShortcuts(e: KeyboardEvent): void {
      if (e.altKey) {
        switch (e.key.toLowerCase()) {
          case 't':
            e.preventDefault();
            this.toggleFeature('textSpacing');
            break;
          case 'c':
            e.preventDefault();
            this.toggleFeature('highContrast');
            break;
          case 'f':
            e.preventDefault();
            this.toggleFeature('focusIndicators');
            break;
          case 'a':
            e.preventDefault();
            window.location.href = '/accessibility';
            break;
        }
      }
    }

    handleOutsideClick(e: MouseEvent): void {
      const target = e.target as HTMLElement;
      const controls = target?.closest('[role="region"][aria-label="Barrierefreiheitsoptionen"]');
      
      if (!controls && this.isPanelVisible()) {
        this.hidePanel();
      }
    }
  }

  // Inicialización optimizada para Astro
  let accessibilityManager: AccessibilityManager | null = null;
  
  function initAccessibility(): void {
    if (!accessibilityManager) {
      accessibilityManager = new AccessibilityManager();
      if (typeof window !== 'undefined') {
        window.accessibilityManager = accessibilityManager;
      }
    }
  }

  // Inicializar en DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAccessibility);
  } else {
    initAccessibility();
  }
  
  // Re-inicializar en navegación Astro
  document.addEventListener('astro:page-load', initAccessibility);
</script>
